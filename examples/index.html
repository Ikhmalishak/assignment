<!DOCTYPE html>
<html>
<head>
    <title>three.js CSS3D - Periodic Table</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        #menu {
            position: absolute;
            bottom: 20px;
            width: 100%;
            text-align: center;
        }

        .element {
            width: 120px;
            height: 160px;
            box-shadow: 0px 0px 12px rgba(0,255,255,0.5);
            border: 1px solid rgba(127,255,255,0.25);
            font-family: Helvetica, sans-serif;
            text-align: center;
            cursor: default;
        }

        .element:hover {
            box-shadow: 0px 0px 12px rgba(0,255,255,0.75);
        }

        .element .number {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 12px;
            color: rgba(127,255,255,0.75);
        }

        .element .symbol {
            position: absolute;
            top: 40px;
            left: 0px;
            right: 0px;
            font-size: 60px;
            font-weight: bold;
            color: rgba(255,255,255,0.75);
        }

        .element .details {
            position: absolute;
            bottom: 15px;
            left: 0px;
            right: 0px;
            font-size: 12px;
            color: rgba(127,255,255,0.75);
        }

        button {
            color: rgba(127,255,255,0.75);
            background: transparent;
            border: 1px solid rgba(127,255,255,0.75);
            padding: 5px 10px;
            cursor: pointer;
        }

        button:hover {
            background-color: rgba(0,255,255,0.5);
        }
    </style>
</head>
<body>

<div id="menu">
    <button id="table">TABLE</button>
</div>
<div id="container"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/110/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/Tween.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/110/examples/js/controls/TrackballControls.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/110/examples/js/renderers/CSS3DRenderer.js"></script>

<script>
    async function fetchData() {
        try {
            const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vQiFsAXJNe7ETQWyyhmX1uvKJeTmjTodekGzZjMIHcSdDqeTyG5yaLHrGmWisC3uiIpwxpBnuS9C0xX/pub?output=csv');
            if (!response.ok) throw new Error('Failed to fetch data');
            const data = await response.text();
            return data.split('\n').map(row => row.split(','));
        } catch (error) {
            console.error('Error fetching data:', error);
            return [];
        }
    }

    async function init() {
        const table = await fetchData();
        console.log('Fetched table data:', table);
        if (!table.length) return;

        const objects = [];
        const targets = { table: [] };

        const camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 1, 10000);
        camera.position.z = 3000;

        const scene = new THREE.Scene();

        const renderer = new THREE.CSS3DRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('container').appendChild(renderer.domElement);

        const controls = new THREE.TrackballControls(camera, renderer.domElement);
        controls.minDistance = 500;
        controls.maxDistance = 6000;

        table.forEach((row, i) => {
            const [symbol, name, weight, col, rowNum] = row;
            if (!symbol || !name || isNaN(weight) || isNaN(col) || isNaN(rowNum)) return;

            const element = document.createElement('div');
            element.className = 'element';
            element.style.backgroundColor = `rgba(0,127,127,${Math.random() * 0.5 + 0.25})`;

            const number = document.createElement('div');
            number.className = 'number';
            number.textContent = i + 1;
            element.appendChild(number);

            const symbolDiv = document.createElement('div');
            symbolDiv.className = 'symbol';
            symbolDiv.textContent = symbol;
            element.appendChild(symbolDiv);

            const details = document.createElement('div');
            details.className = 'details';
            details.innerHTML = `${name}<br>${weight}`;
            element.appendChild(details);

            const objectCSS = new THREE.CSS3DObject(element);
            objectCSS.position.set(Math.random() * 4000 - 2000, Math.random() * 4000 - 2000, Math.random() * 4000 - 2000);
            scene.add(objectCSS);
            objects.push(objectCSS);

            const object = new THREE.Object3D();
            object.position.set((col * 140) - 1330, -(rowNum * 180) + 990, 0);
            targets.table.push(object);
        });

        document.getElementById('table').addEventListener('click', () => transform(targets.table, 2000));

        function transform(targets, duration) {
            TWEEN.removeAll();
            objects.forEach((object, i) => {
                const target = targets[i];
                new TWEEN.Tween(object.position)
                    .to({ x: target.position.x, y: target.position.y, z: target.position.z }, duration)
                    .easing(TWEEN.Easing.Exponential.InOut)
                    .start();
            });
            new TWEEN.Tween({})
                .to({}, duration * 2)
                .onUpdate(() => renderer.render(scene, camera))
                .start();
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            TWEEN.update();
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();
        renderer.render(scene, camera);
    }

    init();
</script>
</body>
</html>
